version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_NAME:-agentdb}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../agent-svc/storage/postgres/migrations:/docker-entrypoint-initdb.d
    ports:
      - "5433:5432"  # Host port 5433 maps to container port 5432
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - agent-network

  agent-svc:
    build:
      context: ../agent-svc
      dockerfile: Dockerfile
    container_name: agent-svc
    environment:
      SERVER_PORT: "8080"
      JWT_SIGNING_SECRET: ${JWT_SIGNING_SECRET:-change-me-in-production}
      DB_HOST: postgres
      DB_PORT: "5432"
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DB_NAME: ${DB_NAME:-agentdb}
      DB_SSL_MODE: disable
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "8080:8080"
    networks:
      - agent-network

  kong:
    image: kong:3.4
    container_name: kong
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_PROXY_LISTEN: "0.0.0.0:8000"
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      KONG_PLUGINS: bundled,jwt
    volumes:
      - ../kong-gateway/kong.yml:/kong/kong.yml:ro
    ports:
      - "8000:8000"   # HTTP proxy (node-agent → Kong → agent-svc)
      - "8443:8443"
    depends_on:
      - agent-svc
    networks:
      - agent-network

  node-agent:
    build:
      context: ../node-agent
      dockerfile: Dockerfile
    # Note: For docker-compose (non-swarm), use: docker-compose up --scale node-agent=5
    # For docker swarm, the deploy.replicas will work automatically
    deploy:
      replicas: 5
    environment:
      AGENT_SVC_URL: http://kong:8000  # Kong HTTP port
      # HOSTNAME is automatically set by Docker to container name (e.g., deploy_node-agent_1)
      # The node-agent will use HOSTNAME to create unique identity and DB paths per replica
      CHUNK_SIZE: "16384"
      CHUNK_INTERVAL_SEC: "1"
      HEARTBEAT_INTERVAL_SEC: "30"
      WORKER_COUNT: "2"
      CHANNEL_SIZE: "100"
    volumes:
      - node_agent_data:/var/lib/node-agent
    depends_on:
      - kong
    networks:
      - agent-network

volumes:
  postgres_data:
  node_agent_data:

networks:
  agent-network:
    driver: bridge

